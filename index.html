<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapiKlip: AI WhatsApp Text Formatter</title>
    <meta name="description" content="Format teks laporan WhatsApp secara otomatis dengan AI. Buat teks tebal, miring, daftar poin, atau tiru format dari contoh dengan sekali klik.">
    <meta name="keywords" content="whatsapp formatter, text formatter, format wa, klippr, rapiklip, ai text formatter">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        textarea::selection { background-color: #a5b4fc; color: black; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; text-align: center; max-width: 90%; width: 400px; }
        
        /* WhatsApp Preview Styles */
        .whatsapp-preview {
            background-color: #e5ddd5; /* WhatsApp background color */
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); /* Subtle pattern */
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
        }
        .whatsapp-chat-bubble {
            background-color: #dcf8c6; /* Chat bubble color */
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            max-width: 80%;
            margin-left: auto; /* Align to the right */
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            word-wrap: break-word;
            white-space: pre-wrap; /* Preserve line breaks */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6 md:p-8">
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">RapiKlip âœ¨</h1>
            <p class="text-gray-600 mt-2">AI WhatsApp Text Formatter</p>
        </div>

        <div class="border border-gray-200 rounded-lg p-4 mb-6">
             <h2 class="text-xl font-semibold text-indigo-800 mb-4">Fitur Bantuan AI</h2>
            <div id="ai-features-panel">
                <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-lg text-indigo-700 mb-2">1. Format Berdasarkan Contoh</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="example-text" class="block text-sm font-medium text-gray-700 mb-1">Tempel Teks Contoh</label>
                            <textarea id="example-text" rows="5" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div>
                            <label for="target-text" class="block text-sm font-medium text-gray-700 mb-1">Tempel Teks Baru</label>
                            <textarea id="target-text" rows="5" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                    </div>
                    <button id="format-by-example-btn" class="mt-3 w-full px-4 py-2 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition-colors">ðŸ¤– Tiru Format</button>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h3 class="font-semibold text-lg text-purple-700 mb-2">2. Format Cerdas & Ringkas</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="smart-format-btn" class="w-full px-4 py-2 bg-purple-500 text-white rounded-md font-semibold hover:bg-purple-600 transition-colors">ðŸ§  Format Cerdas</button>
                        <button id="summarize-btn" class="w-full px-4 py-2 bg-green-500 text-white rounded-md font-semibold hover:bg-green-600 transition-colors">ðŸ“š Ringkas Teks</button>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <label for="editor" class="block text-lg font-semibold text-gray-800 mb-2">Editor Utama & Hasil</label>
            <textarea id="editor" rows="10" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Hasil dari AI akan muncul di sini."></textarea>
        </div>

        <!-- WhatsApp Preview Section -->
        <div class="mt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Tampilan di WhatsApp</h3>
            <div class="whatsapp-preview">
                <div class="whatsapp-chat-bubble" id="whatsapp-output">
                   Tampilan teks Anda akan muncul di sini...
                </div>
            </div>
        </div>

        <div class="mt-6 flex flex-wrap gap-2 justify-end">
             <button id="copy-btn" class="w-full sm:w-auto px-5 py-2 bg-gray-700 text-white rounded-md font-semibold hover:bg-gray-800">Salin Hasil</button>
             <button id="clear-btn" class="w-full sm:w-auto px-5 py-2 bg-red-500 text-white rounded-md font-semibold hover:bg-red-600">Bersihkan Semua</button>
        </div>
    </div>

    <div id="modal" class="modal-overlay"><div id="modal-content-area"></div></div>

    <script>
        const editor = document.getElementById('editor');
        const copyBtn = document.getElementById('copy-btn');
        const clearBtn = document.getElementById('clear-btn');
        const modal = document.getElementById('modal');
        const modalContentArea = document.getElementById('modal-content-area');
        const whatsappOutput = document.getElementById('whatsapp-output');

        function showLoader() { modalContentArea.innerHTML = '<div class="loader"></div>'; modal.classList.add('visible'); }
        function hideModal() { modal.classList.remove('visible'); modalContentArea.innerHTML = ''; }
        function showError(message) {
            modalContentArea.innerHTML = `<div class="modal-content"><h3 class="text-xl font-bold text-red-600 mb-2">Terjadi Kesalahan</h3><p class="text-gray-700">${message}</p><button id="close-modal-btn" class="mt-4 px-4 py-2 bg-red-500 text-white rounded-md">Tutup</button></div>`;
            modal.classList.add('visible');
            document.getElementById('close-modal-btn').addEventListener('click', hideModal);
        }
        
        function updatePreview(text) {
            if (!text) {
                whatsappOutput.innerHTML = 'Tampilan teks Anda akan muncul di sini...';
                return;
            }
            let html = text;
            html = html.replace(/\*(.*?)\*/g, '<b>$1</b>');
            html = html.replace(/_(.*?)_/g, '<i>$1</i>');
            html = html.replace(/~(.*?)~/g, '<s>$1</s>');
            html = html.replace(/```(.*?)```/g, '<tt>$1</tt>');
            
            whatsappOutput.innerHTML = html;
        }
        
        editor.addEventListener('input', (e) => updatePreview(e.target.value));

        function cleanupAIResponse(text) {
            const lines = text.split('\n');
            if (lines.length > 1 && !lines[0].includes('*') && !lines[0].includes('_')) {
               const firstLineLower = lines[0].toLowerCase();
               if (firstLineLower.includes('berikut') || firstLineLower.includes('ini adalah') || firstLineLower.includes('tentu')) {
                   text = lines.slice(1).join('\n').trim();
               }
            }
            text = text.replace(/\*\*+/g, '*').replace(/__+/g, '_');
            return text.trim();
        }

        async function callGeminiAPI(prompt) {
            const response = await fetch('/.netlify/functions/call-gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server error: ${response.status}. ${errorText}`);
            }

            const result = await response.json();
            if (result.candidates && result.candidates[0].content.parts.length > 0) {
                let rawText = result.candidates[0].content.parts[0].text;
                return cleanupAIResponse(rawText);
            } else {
                const blockReason = result.candidates?.[0]?.finishReason;
                throw new Error(blockReason === 'SAFETY' ? "Permintaan diblokir karena alasan keamanan." : "Gagal mendapatkan respons dari AI.");
            }
        }
        
        function addAiFeatureListeners() {
            document.getElementById('format-by-example-btn').addEventListener('click', async () => {
                const example = document.getElementById('example-text').value.trim();
                const target = document.getElementById('target-text').value.trim();
                if (!example || !target) { showError("Mohon isi 'Teks Contoh' dan 'Teks Baru'."); return; }
                showLoader();
                try {
                    const prompt = `Anda adalah AI ahli format. Analisis gaya format dari "CONTOH" dan terapkan gaya yang sama persis ke "TEKS BARU".\n\n---\nCONTOH:\n${example}\n---\nTEKS BARU:\n${target}\n---\n\nHASIL FORMAT (hanya berikan teks yang sudah diformat, tanpa kalimat pembuka):`;
                    const result = await callGeminiAPI(prompt);
                    editor.value = result;
                    updatePreview(result);
                } catch (error) { showError(`Gagal memformat: ${error.message}`); } finally { hideModal(); }
            });

            document.getElementById('smart-format-btn').addEventListener('click', async () => {
                const textToFormat = editor.value.trim();
                if (!textToFormat) { showError("Tidak ada teks di editor untuk diformat."); return; }
                showLoader();
                try {
                    // --- FINAL PROMPT v3 ---
                    const prompt = `Tugas Anda adalah memformat teks berikut untuk WhatsApp dengan aturan yang SANGAT KETAT.
ATURAN UTAMA:
1.  **JAGA STRUKTUR ASLI:** Jika input adalah satu paragraf, output HARUS tetap satu paragraf. Jangan menambahkan baris baru.
2.  **CETAK MIRING (_teks_):** Gunakan HANYA untuk istilah dalam bahasa asing (contoh: _monitoring_, _digital_).
3.  **CETAK TEBAL (*teks*):** Gunakan untuk frasa kunci yang paling menonjolkan tujuan atau kesimpulan utama dari teks. Beri perhatian khusus pada bagian awal (tujuan) dan akhir (kesimpulan) dari paragraf untuk menemukan kandidat cetak tebal.
4.  **JANGAN MENAMBAHKAN TEKS APAPUN:** Jangan memberi kalimat pembuka/penutup.

CONTOH YANG DIINGINKAN:
Input: "Pemerintah pusat dan daerah disarankan memperkuat edukasi dan sosialisasi CKG, khususnya di wilayah dengan kerawanan tinggi dan akses digital terbatas. Optimalisasi pemanfaatan teknologi digital, pelibatan aktif tenaga kesehatan, serta pemberdayaan tokoh masyarakat sangat penting untuk meningkatkan monitoring berkelanjutan dan memastikan keberlanjutan serta dampak jangka panjang program CKG."
Output yang Diinginkan: "Pemerintah pusat dan daerah disarankan *memperkuat edukasi dan sosialisasi CKG*, khususnya di wilayah dengan kerawanan tinggi dan *akses digital terbatas*. Optimalisasi pemanfaatan teknologi _digital_, pelibatan aktif tenaga kesehatan, serta pemberdayaan tokoh masyarakat sangat penting untuk meningkatkan _monitoring_ berkelanjutan dan *memastikan keberlanjutan serta dampak jangka panjang program CKG*."

Sekarang, format narasi di bawah ini dengan aturan yang sama:
"""
${textToFormat}
"""`;
                    const result = await callGeminiAPI(prompt);
                    editor.value = result;
                    updatePreview(result);
                } catch (error) { showError(`Gagal memformat: ${error.message}`); } finally { hideModal(); }
            });

            document.getElementById('summarize-btn').addEventListener('click', async () => {
                const textToSummarize = editor.value.trim();
                if (!textToSummarize) { showError("Tidak ada teks di editor untuk diringkas."); return; }
                showLoader();
                try {
                    const prompt = `Ringkas teks ini menjadi poin-poin penting untuk laporan singkat di WhatsApp. Gunakan format WhatsApp (*tebal*, _miring_, - daftar).\n\nTeks Asli:\n"""\n${textToSummarize}\n"""`;
                    const result = await callGeminiAPI(prompt);
                    editor.value = result;
                    updatePreview(result);
                } catch (error) { showError(`Gagal meringkas: ${error.message}`); } finally { hideModal(); }
            });
        }

        copyBtn.addEventListener('click', () => {
            if (!editor.value) return;
            editor.select();
            document.execCommand('copy');
            alert('Teks berhasil disalin!');
        });
        clearBtn.addEventListener('click', () => {
            editor.value = '';
            document.getElementById('example-text').value = '';
            document.getElementById('target-text').value = '';
            updatePreview('');
            editor.focus();
        });

        document.addEventListener('DOMContentLoaded', addAiFeatureListeners);
        updatePreview(editor.value);
    </script>
</body>
</html>
