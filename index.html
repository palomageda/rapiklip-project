<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediaDash ‚Äì Media Collage (Auto Ratio, HQ Export)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    .tab-btn{position:relative;padding:10px 14px;color:#6b7280;font-weight:600;border-bottom:2px solid transparent}
    .tab-btn.active{color:#4f46e5;border-color:#4f46e5}
    canvas{image-rendering:auto}
  </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
  <header class="bg-white sticky top-0 z-40 border-b border-gray-200/80">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-xl font-bold">MediaDash ‚ú®</div>
        <button id="backBtn" class="hidden text-sm text-indigo-600 hover:text-indigo-700">‚Üê Kembali ke Dasbor</button>
      </div>
      <div class="flex items-center gap-2">
        <button id="loginBtn" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700">Login / Daftar</button>
      </div>
    </nav>
  </header>

  <main class="px-4 py-8 sm:px-6 lg:px-8">
    <section id="hub" class="max-w-6xl mx-auto">
      <div class="text-center py-10 md:py-14">
        <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-gray-900">Konten Lebih Baik, <span class="text-indigo-600">Lebih Cepat.</span></h1>
        <p class="mt-4 max-w-2xl mx-auto text-gray-600">Format teks, susun kolase, dan segera‚Äîjadwalkan posting. Satu tempat, alur kerja cepat.</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <article id="card-formatter" class="bg-white p-6 rounded-2xl shadow hover:shadow-lg transition cursor-pointer">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-xl bg-indigo-100 text-indigo-600 grid place-items-center">üìÑ</div>
            <h3 class="text-lg font-bold">AI Text Formatter</h3>
          </div>
          <p class="mt-3 text-gray-600">Perapihan cepat untuk WhatsApp dan caption‚Äîheading, bullet, & ringkasan otomatis.</p>
          <div class="mt-4 text-indigo-600 font-semibold">Buka Formatter ‚Üí</div>
        </article>

        <article id="card-collage" class="bg-white p-6 rounded-2xl shadow hover:shadow-lg transition cursor-pointer">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-xl bg-emerald-100 text-emerald-600 grid place-items-center">üñºÔ∏è</div>
            <h3 class="text-lg font-bold">Media Collage</h3>
          </div>
          <p class="mt-3 text-gray-600">Susun puluhan foto cepat: mosaic unequal, gap minimal, ekspor tajam untuk cetak.</p>
          <div class="mt-4 text-emerald-600 font-semibold">Buka Editor ‚Üí</div>
        </article>

        <article class="bg-white p-6 rounded-2xl shadow opacity-60">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-xl bg-gray-100 text-gray-500 grid place-items-center">üóìÔ∏è</div>
            <h3 class="text-lg font-bold">Social Media Scheduler</h3>
          </div>
          <p class="mt-3 text-gray-600">Posting lintas platform. <span class="font-semibold">Segera hadir.</span></p>
          <div class="mt-4 text-gray-400 font-semibold">Segera Hadir</div>
        </article>
      </div>
    </section>

    <section id="app" class="hidden max-w-7xl mx-auto"></section>
  </main>

  <script type="module">
    const $ = (s,r=document)=>r.querySelector(s);
    const hub=$('#hub'); const app=$('#app'); const backBtn=$('#backBtn');
    $('#card-collage').addEventListener('click',()=>showCollage());
    $('#card-formatter').addEventListener('click',()=>showFormatter());
    backBtn.addEventListener('click',()=>{app.classList.add('hidden'); hub.classList.remove('hidden'); backBtn.classList.add('hidden');});

    function showFormatter(){
      hub.classList.add('hidden'); app.classList.remove('hidden'); backBtn.classList.remove('hidden');
      app.innerHTML=`
        <div class="mb-6 border-b border-gray-200">
          <nav class="-mb-px flex gap-6"><button class="tab-btn active">Formatter Teks</button></nav>
        </div>
        <section class="bg-white rounded-2xl shadow p-6"><h2 class="text-xl font-bold mb-2">AI Text Formatter</h2><p class="text-gray-600">Area formatter stabil. (Pasang implementasi formatter milikmu di sini jika perlu.)</p></section>`;
    }

    function collageTemplate(){
      return `
      <div class="mb-6 border-b border-gray-200"><nav class="-mb-px flex gap-6"><button id="tab-collage" class="tab-btn active">Media Collage</button><button id="tab-album" class="tab-btn">Media Album</button></nav></div>
      <div id="collage-grid" class="grid lg:grid-cols-3 gap-6" style="height:0">
        <section class="lg:col-span-2 bg-white rounded-2xl shadow p-4 md:p-6 flex">
          <div id="collage-shell" class="relative w-full bg-gray-100 rounded-lg overflow-hidden" style="height:100%"><canvas id="canvas" class="block mx-auto"></canvas></div>
        </section>
        <aside class="bg-white rounded-2xl shadow p-4 md:p-6 overflow-auto">
          <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Tambah Foto</label><input id="file" type="file" accept="image/*" multiple class="block w-full text-sm" /><div class="text-xs text-gray-500 mt-1">Drag & drop ke area kanvas juga bisa.</div></div>
          <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Pattern</label><select id="pattern" class="w-full border rounded p-2"><option value="grid">Picture Grid (Equal)</option><option value="mosaic" selected>Picture Grid (Unequal) / Mosaic</option><option value="center">Center Frame</option><option value="zigzag">Zig Zag</option><option value="wall">Photo Wall</option><option value="pile">Advanced Pile</option><option value="polaroid">Polaroid</option><option value="mood">Mood Board / Gallery</option></select></div>
          <div class="space-y-3">
            <div class="flex items-center gap-2 text-sm text-gray-700"><label>Ratio</label><select id="ratio" class="border rounded p-1"><option value="auto" selected>Auto (fit all, portrait)</option><option value="1:1">1:1</option><option value="4:5">4:5</option><option value="3:2">3:2</option><option value="16:9">16:9</option><option value="9:16">9:16</option></select><label class="ml-3">Orientation</label><select id="orientation" class="border rounded p-1" disabled><option value="portrait" selected>Portrait</option><option value="landscape">Landscape</option></select></div>
            <label class="block text-sm">Gap <input id="gap" type="range" min="0" max="40" value="4" class="w-full"></label>
            <label class="block text-sm">Radius <input id="radius" type="range" min="0" max="40" value="10" class="w-full"></label>
            <label class="block text-sm">Padding <input id="padding" type="range" min="0" max="100" value="16" class="w-full"></label>
            <div class="flex items-center justify-between"><label class="text-sm">Background</label><input id="bg" type="color" value="#ffffff" /></div>
            <div class="grid grid-cols-2 gap-2"><button id="btn-shuffle" class="px-2 py-2 rounded bg-gray-100 hover:bg-gray-200">Shuffle</button><button id="btn-clear" class="px-2 py-2 rounded bg-red-50 text-red-600 hover:bg-red-100">Bersihkan</button></div>
            <div class="pt-3 border-t space-y-2">
              <div><label class="block text-sm font-medium">Format</label><select id="export-format" class="border rounded p-1 mt-1 w-full"><option value="jpg" selected>JPEG (foto, ukuran lebih kecil)</option><option value="png">PNG (lossless)</option></select></div>
              <div id="qwrap"><label class="block text-sm">JPEG Quality <span id="qval" class="text-gray-500">98</span><input id="export-quality" type="range" min="80" max="100" value="98" class="w-full" /></label></div>
              <div><label class="block text-sm font-medium">Lebar Export</label><select id="export-size" class="border rounded p-1 mt-1 w-full"><option value="6000">6000 px (print besar)</option><option value="4961">A2 (4961 px @300dpi)</option><option value="3508" selected>A3 (3508 px @300dpi)</option><option value="2480">A4 (2480 px @300dpi)</option><option value="3543">30√ó45 cm (3543 px short side)</option><option value="2362">20√ó30 cm (2362 px short side)</option><option value="2048">2048 px</option><option value="1080">1080 px</option><option value="custom">Custom‚Ä¶</option></select><input id="export-custom" type="number" min="600" step="10" placeholder="Lebar px" class="hidden mt-2 w-full border rounded p-1" /></div>
            </div>
            <div class="pt-3 border-t flex items-center gap-2 flex-wrap"><button id="btn-arrange" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Arrange ‚Ä¢ Minimize Cropping</button><button id="btn-export" class="px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">Download</button></div>
          </div>
        </aside>
      </div>
      <div id="album-grid" class="hidden"><section class="bg-white rounded-2xl shadow p-6 min-h-[50vh] flex items-center justify-center text-gray-500"><div><h3 class="text-xl font-semibold text-gray-800 mb-2">Media Album</h3><p>Area ini disiapkan untuk fitur SmartAlbums (spread, gutter/bleed, proofing). Coming soon.</p></div></section></div>`;
    }

    function showCollage(){ hub.classList.add('hidden'); app.classList.remove('hidden'); backBtn.classList.remove('hidden'); app.innerHTML=collageTemplate(); bindCollage(); bindTabs(); }

    function bindCollage(){
      const canvas=$('#canvas'); const ctx=canvas.getContext('2d'); let dpr=Math.max(1, window.devicePixelRatio||1);
      const state={ imgs:[], pattern:'mosaic', gap:4, radius:10, padding:16, bg:'#ffffff', ratio:'auto', autoRatio:true, orientation:'portrait', seed:Date.now(), mosaicCols:null, autoFrames:null, autoNatural:{w:0,h:0} };

      function sizeGrid(){ const grid=$('#collage-grid'); const top=Math.ceil(grid.getBoundingClientRect().top); const h=Math.max(300, window.innerHeight-top-16); grid.style.height=h+'px'; $('#collage-shell').style.height='100%'; fitCanvas(); }
      window.addEventListener('resize', ()=>{ dpr=Math.max(1, window.devicePixelRatio||1); sizeGrid(); });

      // ======= Mosaic helpers (frames independent of height) =======
      function mosaicFramesFor(W, cols){ const gap=state.gap, pad=state.padding; const innerW=W-2*pad; const colW=(innerW-gap*(cols-1))/cols; const heights=new Array(cols).fill(pad); const frames=[]; const n=state.imgs.length; for(let i=0;i<n;i++){ let c=0; for(let k=1;k<cols;k++) if(heights[k]<heights[c]) c=k; const x=pad+c*(colW+gap); const src=state.imgs[i]; const ar=(src?.w&&src?.h)?src.w/src.h:3/4; const h=Math.max(60,colW/ar); frames.push({x,y:heights[c],w:colW,h}); heights[c]+=h+gap; } const usedH=Math.max(...heights)-gap; return {frames, usedH}; }
      function mosaicBestForWidth(W){ const minCols=2, maxCols=12; let best=null; for(let c=minCols;c<=maxCols;c++){ const r=mosaicFramesFor(W,c); const portraitEnough=r.usedH>=W*0.98; const score = (portraitEnough?0:1)*1e6 + Math.abs(r.usedH - Math.max(W,r.usedH)); // prefer portrait & compact
        if(!best || score<best.score){ best={score, cols:c, usedH:r.usedH, frames:r.frames}; } }
        // enforce portrait: if best.usedH < W pick smallest cols (tallest)
        if(best.usedH < W){ const r=mosaicFramesFor(W,2); best={score:0, cols:2, usedH:r.usedH, frames:r.frames}; }
        return best; }

      function fitCanvas(){ const shell=$('#collage-shell'); const maxW=shell.clientWidth, maxH=shell.clientHeight; let width=maxW, height=maxH; let scale=1; if(state.pattern==='mosaic' && state.autoRatio){ const best=mosaicBestForWidth(width); state.mosaicCols=best.cols; state.autoFrames=best.frames; state.autoNatural={w:width,h:best.usedH+2*state.padding}; const Hnat=state.autoNatural.h; scale=Math.min(1, maxH/Hnat); canvas.style.width=width*scale+'px'; canvas.style.height=Hnat*scale+'px'; canvas.width=Math.round(width*scale*dpr); canvas.height=Math.round(Hnat*scale*dpr); ctx.setTransform(dpr*scale,0,0,dpr*scale,0,0); drawPreview(); return; }
        // non-auto (fixed ratio)
        let [rw,rh]=state.ratio.split(':').map(Number); if(state.orientation==='portrait'&&rw>rh)[rw,rh]=[rh,rw]; if(state.orientation==='landscape'&&rh>rw)[rw,rh]=[rh,rw]; width=maxW; height=Math.round(width*rh/rw); if(height>maxH){ height=maxH; width=Math.round(height*rw/rh); }
        canvas.style.width=width+'px'; canvas.style.height=height+'px'; canvas.width=Math.round(width*dpr); canvas.height=Math.round(height*dpr); ctx.setTransform(dpr,0,0,dpr,0,0); drawPreview(); }

      // ======= File inputs =======
      const file=$('#file'); file.addEventListener('change',()=>loadFiles(file.files)); const host=$('#collage-shell'); ['dragenter','dragover','dragleave','drop'].forEach(ev=>host.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();})); host.addEventListener('drop',e=>loadFiles(e.dataTransfer.files));
      function loadFiles(list){ const arr=[...list].filter(f=>f.type.startsWith('image/')); if(!arr.length) return; Promise.all(arr.map(readImage)).then(imgs=>{ state.imgs.push(...imgs); fitCanvas(); }); }
      function readImage(file){ return new Promise(res=>{ const img=new Image(); img.onload=()=>res({img,w:img.naturalWidth,h:img.naturalHeight}); img.src=URL.createObjectURL(file); }); }

      // ======= Controls =======
      $('#ratio').addEventListener('change',e=>{state.ratio=e.target.value; state.autoRatio=(state.pattern==='mosaic' && e.target.value==='auto'); $('#orientation').disabled=state.autoRatio; fitCanvas();});
      $('#orientation').addEventListener('change',e=>{state.orientation=e.target.value; fitCanvas();});
      $('#pattern').addEventListener('change',e=>{state.pattern=e.target.value; if(state.pattern==='mosaic'){ state.autoRatio = ($('#ratio').value==='auto'); $('#orientation').value='portrait'; $('#orientation').disabled=state.autoRatio; } else { state.autoRatio=false; $('#ratio').value='4:5'; $('#orientation').disabled=false; } fitCanvas();});
      ['gap','radius','padding','bg'].forEach(id=>$("#"+id).addEventListener('input',()=>fitCanvas()));
      $('#btn-shuffle').addEventListener('click',()=>{shuffle(state.imgs); fitCanvas();});
      $('#btn-clear').addEventListener('click',()=>{state.imgs.length=0; fitCanvas();});

      const fmt=$('#export-format'); const qwrap=$('#qwrap'); const qval=$('#qval'); const qrange=$('#export-quality'); fmt.addEventListener('change',()=>{ qwrap.classList.toggle('hidden', fmt.value!=='jpg'); }); qrange.addEventListener('input',()=>{ qval.textContent=qrange.value; }); $('#export-size').addEventListener('change',e=>$('#export-custom').classList.toggle('hidden', e.target.value!=='custom'));
      $('#btn-arrange').addEventListener('click',()=>{ arrangeMinCrop(); fitCanvas(); });
      $('#btn-export').addEventListener('click',exportHQ);

      function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
      function roundRectPath(ctx,x,y,w,h,r){ const rr=Math.min(r,Math.min(w,h)/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }

      function arrangeMinCrop(){ if(!state.imgs.length) return; // sederhana: urutkan berdasarkan rasio mendekati kolom frame rata2
        if(state.pattern==='mosaic'){ const cols = state.mosaicCols||2; const colW = ( (state.autoNatural.w||$('#collage-shell').clientWidth) - 2*state.padding - state.gap*(cols-1) )/cols; const targetAR = colW / (colW*1.4); // kira2 portrait
          state.imgs.sort((a,b)=> Math.abs(a.w/a.h-targetAR)-Math.abs(b.w/b.h-targetAR)); }
      }

      function drawContain(ctx,img,rect){ const iw=img.naturalWidth, ih=img.naturalHeight; const sc=Math.min(rect.w/iw, rect.h/ih); const dw=iw*sc, dh=ih*sc; const dx=rect.x+(rect.w-dw)/2, dy=rect.y+(rect.h-dh)/2; ctx.drawImage(img,dx,dy,dw,dh); }
      function drawWatermark(ctx,W,H){ const pad=14; ctx.save(); ctx.globalAlpha=.9; ctx.fillStyle='rgba(255,255,255,.95)'; ctx.font='700 '+Math.round(W*0.018)+'px Inter, system-ui, -apple-system'; const text='mediadash.id'; const tw=ctx.measureText(text).width; const x=W - tw - pad*1.2, y=H - pad; ctx.fillRect(x-pad*.6, y-Math.round(W*0.02), tw+pad*1.2, Math.round(W*0.023)); ctx.fillStyle='#111827'; ctx.fillText(text, x, y-4); ctx.restore(); }

      function drawPreview(){ const W=canvas.width/(Math.max(1, window.devicePixelRatio||1)); const H=canvas.height/(Math.max(1, window.devicePixelRatio||1)); ctx.clearRect(0,0,W,H); ctx.fillStyle=state.bg; ctx.fillRect(0,0,W,H);
        if(state.pattern==='mosaic' && state.autoRatio && state.autoFrames){ const frames=state.autoFrames; frames.forEach((f,i)=>{ const src=state.imgs[i]; if(!src) return; ctx.save(); roundRectPath(ctx,f.x,f.y,f.w,f.h,state.radius); ctx.clip(); drawContain(ctx,src.img,{x:f.x,y:f.y,w:f.w,h:f.h}); ctx.restore(); }); drawWatermark(ctx,W,H); return; }
        // fallback untuk selain auto
        const frames = computeFramesFixed(W,H); frames.forEach((f,i)=>{ const src=state.imgs[i%state.imgs.length]; if(!src) return; ctx.save(); if(f.rot){ ctx.translate(f.x+f.w/2,f.y+f.h/2); ctx.rotate(f.rot); ctx.translate(-f.x-f.w/2,-f.y-f.h/2); } if(f.polaroid){ const bw=Math.max(6,Math.min(f.w,f.h)*0.04), btm=bw*3; ctx.fillStyle='#fff'; roundRectPath(ctx,f.x,f.y,f.w,f.h+btm,state.radius); ctx.fill(); const inner={x:f.x+bw,y:f.y+bw,w:f.w-2*bw,h:f.h-2*bw}; drawContain(ctx,src.img,inner); } else { roundRectPath(ctx,f.x,f.y,f.w,f.h,state.radius); ctx.clip(); drawContain(ctx,src.img,{x:f.x,y:f.y,w:f.w,h:f.h}); } ctx.restore(); }); drawWatermark(ctx,W,H); }

      function computeFramesFixed(W,H){ const box={x:0,y:0,w:W,h:H}; const n=state.imgs.length; switch(state.pattern){ case 'grid': return layoutGrid(box,n); case 'mosaic': return mosaicFramesFor(W, state.mosaicCols||2).frames; case 'center': return layoutCenter(box,n); case 'zigzag': return layoutZigzag(box,n); case 'wall': return layoutWall(box,n); case 'pile': return layoutPile(box,n); case 'polaroid': return layoutPolaroid(box,n); case 'mood': return layoutMood(box,n); default: return layoutGrid(box,n);} }

      // ========== Alternative layouts (fixed-box) ==========
      function layoutGrid(box,n){ if(n===0) return []; const cols=Math.ceil(Math.sqrt(n)); const rows=Math.ceil(n/cols); const {gap,padding}=state; const iw=(box.w-2*padding-gap*(cols-1))/cols; const ih=(box.h-2*padding-gap*(rows-1))/rows; const frames=[]; let k=0; for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ if(k>=n) break; const x=box.x+padding+c*(iw+gap); const y=box.y+padding+r*(ih+gap); frames.push({x,y,w:iw,h:ih}); k++; } } return frames; }
      function layoutCenter(box,n){ const {gap,padding}=state; const inner={x:box.x+padding,y:box.y+padding,w:box.w-2*padding,h:box.h-2*padding}; const big={x:inner.x,y:inner.y,w:inner.w*0.6-gap/2,h:inner.h*0.6-gap/2}; const right={x:big.x+big.w+gap,y:inner.y,w:inner.w-big.w-gap,h:inner.h}; const bottom={x:inner.x,y:big.y+big.h+gap,w:big.w,h:inner.h-big.h-gap}; const frames=[big]; frames.push(...layoutGrid(right,Math.ceil((n-1)/2))); frames.push(...layoutGrid(bottom,Math.floor((n-1)/2))); return frames.slice(0,n); }
      function layoutZigzag(box,n){ const {gap,padding}=state; const col=2; const inner={x:box.x+padding,y:box.y+padding,w:box.w-2*padding,h:box.h-2*padding}; const colW=(inner.w-gap)/col; const rows=Math.ceil(n/2); const rowH=(inner.h-gap*(rows-1))/rows; const frames=[]; let i=0; for(let r=0;r<rows;r++){ const y=inner.y+r*(rowH+gap); const x1=r%2===0?inner.x:inner.x+colW+gap; const x2=r%2===0?inner.x+colW+gap:inner.x; frames.push({x:x1,y,w:colW,h:rowH}); if(++i<n) frames.push({x:x2,y,w:colW,h:rowH}); i++; } return frames.slice(0,n); }
      function layoutWall(box,n){ const {gap,padding}=state; const inner={x:box.x+padding,y:box.y+padding,w:box.w-2*padding,h:box.h-2*padding}; const target=inner.h/Math.ceil(Math.sqrt(n)); let y=inner.y; const frames=[]; let i=0; while(i<n&&y<inner.y+inner.h){ let x=inner.x; const rowH=target*(.8+0.4*Math.random()); while(i<n&&x<inner.x+inner.w){ const ar=(state.imgs[i%state.imgs.length]?.w/state.imgs[i%state.imgs.length]?.h)||1; let w=rowH*ar; if(x+w>inner.x+inner.w) w=inner.x+inner.w-x; frames.push({x,y,w:w-state.gap/2,h:rowH-state.gap/2}); x+=w+state.gap; i++; } y+=rowH+state.gap; } return frames; }
      function layoutPile(box,n){ const {padding}=state; const inner={x:box.x+padding,y:box.y+padding,w:box.w-2*padding,h:box.h-2*padding}; const frames=[]; for(let i=0;i<n;i++){ const sc=.55+.45*Math.random(); const w=inner.w*sc*0.6, h=inner.h*sc*0.6; const x=inner.x+Math.random()*(inner.w-w); const y=inner.y+Math.random()*(inner.h-h); const rot=(Math.random()-.5)*0.35; frames.push({x,y,w,h,rot}); } return frames; }
      function layoutPolaroid(box,n){ return layoutPile(box,n).map(f=>({...f,polaroid:true})); }
      function layoutMood(box,n){ const {gap,padding}=state; const inner={x:box.x+padding,y:box.y+padding,w:box.w-2*padding,h:box.h-2*padding}; const cells=[{x:inner.x,y:inner.y,w:inner.w*.62-gap,h:inner.h*.62-gap},{x:inner.x+inner.w*.64,y:inner.y,w:inner.w*.36-gap,h:inner.h*.36-gap},{x:inner.x+inner.w*.64,y:inner.y+inner.h*.38,w:inner.w*.36-gap,h:inner.h*.24-gap},{x:inner.x,y:inner.y+inner.h*.64,w:inner.w*.44-gap,h:inner.h*.36-gap},{x:inner.x+inner.w*.46,y:inner.y+inner.h*.64,w:inner.w*.54-gap,h:inner.h*.36-gap}]; return cells.slice(0,Math.min(n,cells.length)); }

      function exportHQ(){ const fmt=$('#export-format').value; const q=parseInt($('#export-quality').value,10)/100; const sel=$('#export-size'); let width=parseInt(sel.value,10); if(sel.value==='custom'){ width=parseInt($('#export-custom').value,10)||4000; }
        let frames, outH;
        if(state.pattern==='mosaic' && state.autoRatio){ const best=mosaicBestForWidth(width); state.mosaicCols=best.cols; frames=best.frames; outH=Math.round(best.usedH+2*state.padding); }
        else { // fixed-ratio or other patterns
          let [rw,rh]=(state.ratio||'4:5').split(':').map(Number); if(state.orientation==='portrait'&&rw>rh)[rw,rh]=[rh,rw]; if(state.orientation==='landscape'&&rh>rw)[rw,rh]=[rh,rw]; outH=Math.round(width*rh/rw); const tmp=mosaicFramesFor(width, state.mosaicCols||2); frames = computeFramesFixed(width,outH); }
        const out=document.createElement('canvas'); out.width=width; out.height=outH; const octx=out.getContext('2d',{alpha:false}); octx.imageSmoothingEnabled=true; octx.imageSmoothingQuality='high'; octx.fillStyle=state.bg; octx.fillRect(0,0,out.width,out.height);
        (state.pattern==='mosaic' && state.autoRatio ? frames : computeFramesFixed(width,outH)).forEach((f,i)=>{ const src=state.imgs[i%state.imgs.length]; if(!src) return; octx.save(); if(f.rot){ octx.translate(f.x+f.w/2,f.y+f.h/2); octx.rotate(f.rot); octx.translate(-f.x-f.w/2,-f.y-f.h/2);} if(f.polaroid){ const bw=Math.max(6,Math.min(f.w,f.h)*0.04), btm=bw*3; octx.fillStyle='#fff'; roundRectPath(octx,f.x,f.y,f.w,f.h+btm,state.radius); octx.fill(); const inner={x:f.x+bw,y:f.y+bw,w:f.w-2*bw,h:f.h-2*bw}; drawContain(octx,src.img,inner); } else { roundRectPath(octx,f.x,f.y,f.w,f.h,state.radius); octx.clip(); drawContain(octx,src.img,{x:f.x,y:f.y,w:f.w,h:f.h}); } octx.restore(); });
        drawWatermark(octx,out.width,out.height);
        const mime = fmt==='png' ? 'image/png' : 'image/jpeg'; const data = fmt==='png' ? out.toDataURL(mime) : out.toDataURL(mime, Math.min(1, Math.max(0.8, q))); const a=document.createElement('a'); a.href=data; a.download='mediadash-collage.'+(fmt==='png'?'png':'jpg'); a.click(); }

      sizeGrid();
    }

    function bindTabs(){ const b1=$('#tab-collage'), b2=$('#tab-album'); const v1=$('#collage-grid'), v2=$('#album-grid'); function act(name){ b1.classList.toggle('active',name==='collage'); b2.classList.toggle('active',name==='album'); v1.classList.toggle('hidden',name!=='collage'); v2.classList.toggle('hidden',name!=='album'); if(name==='collage'){ const evt=new Event('resize'); window.dispatchEvent(evt);} } b1.addEventListener('click',()=>act('collage')); b2.addEventListener('click',()=>act('album')); act('collage'); }
  </script>
</body>
</html>
