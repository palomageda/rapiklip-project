<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Text Formatter — MediaDash</title>
  <meta name="description" content="Format teks untuk WhatsApp/medsos, perbaiki style dengan AI, dan pratinjau instan." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .wa-bg {
      background-image: radial-gradient(#0000000d 1px, transparent 1px);
      background-size: 12px 12px;
    }
    .wa-bubble {
      background: #e7ffd8;
      border-radius: 16px;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      border-bottom-right-radius: 4px;
      box-shadow: 0 1px 1px rgb(0 0 0 / .05), 0 2px 4px rgb(0 0 0 / .04);
    }
    .kbd {
      border: 1px solid #e5e7eb; border-bottom-width: 2px;
      border-radius: .375rem; padding: .125rem .375rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .75rem;
      background: #fff;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-full text-gray-800">
  <!-- Navbar -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/" class="text-lg font-extrabold tracking-tight">MediaDash <span class="text-indigo-600">✨</span></a>
        <a href="/" class="text-sm text-gray-500 hover:text-gray-700">&larr; Kembali ke Dasbor</a>
      </div>
      <div class="flex items-center gap-2">
        <a href="#" class="px-3 py-1.5 rounded-md text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-700">Login / Daftar</a>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="mb-6">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-gray-900">AI Text Formatter</h1>
      <p class="text-gray-600 mt-1">Tulis atau tempel teks, format manual, atau minta AI merapikan untuk WhatsApp & media sosial. Pratinjau akan muncul di sebelah kanan.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Editor card -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-4 sm:px-6 py-4 border-b border-gray-200 flex items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <button id="btn-bold"   class="px-3 py-1.5 rounded-md border text-sm font-semibold hover:bg-gray-50">B</button>
            <button id="btn-italic" class="px-3 py-1.5 rounded-md border text-sm font-semibold hover:bg-gray-50 italic">I</button>
            <button id="btn-strike" class="px-3 py-1.5 rounded-md border text-sm font-semibold hover:bg-gray-50 line-through">S</button>
            <button id="btn-mono"   class="px-3 py-1.5 rounded-md border text-sm font-semibold hover:bg-gray-50"><span class="kbd">mono</span></button>
            <span class="hidden sm:inline-block text-gray-300 select-none">|</span>
            <button id="btn-bullets" class="px-3 py-1.5 rounded-md border text-sm hover:bg-gray-50">• Bullet</button>
            <button id="btn-numbers" class="px-3 py-1.5 rounded-md border text-sm hover:bg-gray-50">1. Number</button>
          </div>
          <div class="flex items-center gap-2">
            <select id="tone" class="text-sm border-gray-300 rounded-md">
              <option value="netral" selected>Nada: Netral</option>
              <option value="santai">Nada: Santai</option>
              <option value="profesional">Nada: Profesional</option>
              <option value="persuasif">Nada: Persuasif</option>
            </select>
            <select id="length" class="text-sm border-gray-300 rounded-md">
              <option value="ringkas" selected>Panjang: Ringkas</option>
              <option value="sedang">Sedang</option>
              <option value="lengkap">Lengkap</option>
            </select>
            <button id="btn-ai" class="px-3 py-1.5 rounded-md bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700">✨ Format dengan AI</button>
          </div>
        </div>

        <div class="p-4 sm:p-6">
          <textarea id="editor" rows="10" placeholder="Tulis atau tempel teks di sini..."
            class="w-full resize-y min-h-[220px] rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 p-3"></textarea>

          <div class="mt-3 flex flex-wrap items-center gap-2">
            <button id="btn-clear" class="px-3 py-1.5 rounded-md border text-sm hover:bg-gray-50">Bersihkan</button>
            <button id="btn-copy"  class="px-3 py-1.5 rounded-md border text-sm hover:bg-gray-50">Salin</button>
            <span class="text-xs text-gray-500 ml-auto" id="counter">0 karakter</span>
          </div>

          <div id="note" class="mt-3 hidden text-sm"></div>
        </div>
      </section>

      <!-- Preview card -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
          <h2 class="font-semibold">Pratinjau WhatsApp</h2>
        </div>
        <div class="p-4 sm:p-6 wa-bg">
          <div class="max-w-md">
            <div class="wa-bubble p-4">
              <div id="preview" class="prose prose-sm max-w-none">
                <p class="text-gray-500">Teks Anda akan tampil di sini…</p>
              </div>
            </div>
            <div class="text-[10px] text-gray-400 mt-2">mediadash.id</div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ====== Utilities ======
    const $ = (sel) => document.querySelector(sel);

    function escapeHTML(str) {
      return str
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // Convert WA markdown (*bold* _italic_ ~strike~ ```mono```) to HTML for preview only
    function waToHTML(src) {
      // Escape HTML first
      let s = escapeHTML(src);

      // Protect triple backticks blocks
      s = s.replace(/```([\s\S]*?)```/g, (_m, p1) => {
        return `<pre class="whitespace-pre-wrap bg-gray-100 rounded px-2 py-1 text-[.9em]">${escapeHTML(p1)}</pre>`;
      });

      // Inline monospace using single backtick
      s = s.replace(/`([^`]+?)`/g, (_m, p1) => `<code class="bg-gray-100 rounded px-1">${p1}</code>`);

      // Bold / Italic / Strike
      s = s.replace(/\*([^\*\n]+)\*/g, '<strong>$1</strong>');
      s = s.replace(/_([^_\n]+)_/g, '<em>$1</em>');
      s = s.replace(/~([^~\n]+)~/g, '<del>$1</del>');

      // Newlines to <br>
      s = s.replace(/\n/g, '<br/>');
      return s;
    }

    function updateCounter() {
      const len = $('#editor').value.length;
      $('#counter').textContent = `${len} karakter`;
    }

    function updatePreview() {
      const txt = $('#editor').value.trim();
      $('#preview').innerHTML = txt ? waToHTML(txt) : '<p class="text-gray-500">Teks Anda akan tampil di sini…</p>';
      updateCounter();
    }

    // ====== Formatting actions ======
    function wrapSelection(textarea, left, right = left) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const val = textarea.value;
      const hasSel = start !== end;
      const before = val.slice(0, start);
      const sel = val.slice(start, end);
      const after = val.slice(end);
      const insert = hasSel ? left + sel + right : left + right;
      const pos = hasSel ? start + left.length + sel.length + right.length : start + left.length;
      textarea.value = before + insert + after;
      textarea.focus();
      textarea.setSelectionRange(pos, pos);
      updatePreview();
    }

    function prefixLines(textarea, prefix) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const val = textarea.value;
      const before = val.slice(0, start);
      const sel = val.slice(start, end) || '';
      const after = val.slice(end);
      const lines = (sel || '\n').split('\n');
      const transformed = lines.map(l => l.trim() ? `${prefix}${l}` : l).join('\n');
      const result = before + transformed + after;
      textarea.value = result;
      const newEnd = before.length + transformed.length;
      textarea.focus();
      textarea.setSelectionRange(newEnd, newEnd);
      updatePreview();
    }

    // ====== AI Integration ======
    async function callGeminiAPI(prompt, base64Data, mimeType) {
      const res = await fetch('/.netlify/functions/call-gemini', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, base64Data, mimeType })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) {
        const msg = data?.error || `HTTP_${res.status}`;
        throw new Error(msg);
      }
      return data.response || '';
    }

    function setNote(msg, type='info') {
      const el = $('#note');
      el.classList.remove('hidden', 'text-red-600', 'text-amber-600', 'text-green-600');
      el.classList.add(type === 'error' ? 'text-red-600' : type === 'warn' ? 'text-amber-600' : 'text-green-600');
      el.textContent = msg;
    }

    function clearNote() {
      const el = $('#note');
      el.classList.add('hidden');
      el.textContent = '';
    }

    async function aiFormat() {
      clearNote();
      const input = $('#editor').value.trim();
      if (!input) { setNote('Tolong isi teks terlebih dahulu.', 'warn'); return; }

      const tone = $('#tone').value;      // santai / profesional / persuasif / netral
      const length = $('#length').value;  // ringkas / sedang / lengkap

      const btn = $('#btn-ai');
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '⏳ Memformat…';

      try {
        const prompt = [
          'Tolong format teks berikut agar siap kirim di WhatsApp:',
          '- Pertahankan makna asli, hilangkan pengulangan/typo.',
          '- Gunakan markdown WhatsApp: *bold*, _italic_, ~strikethrough~, ```monospace``` bila perlu.',
          `- Nada: ${tone}. Panjang: ${length}.`,
          '- Jika cocok, jadikan poin/bullet, tambahkan paragraf yang rapi.',
          '- Jangan tambahkan pembuka/penutup bertele-tele.',
          '- Balas hanya teks hasil akhir (tanpa penjelasan).',
          '',
          input
        ].join('\n');

        const out = await callGeminiAPI(prompt);
        if (!out) throw new Error('AI tidak mengembalikan teks.');
        $('#editor').value = out.trim();
        updatePreview();
        setNote('Teks berhasil diformat oleh AI.', 'info');
      } catch (err) {
        console.error(err);
        setNote(`Gagal memanggil AI: ${err.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      }
    }

    // ====== Bindings ======
    window.addEventListener('DOMContentLoaded', () => {
      // Persist kecil via sessionStorage
      const saved = sessionStorage.getItem('md_formatter_text');
      if (saved) $('#editor').value = saved;
      updatePreview();

      $('#editor').addEventListener('input', () => {
        updatePreview();
        sessionStorage.setItem('md_formatter_text', $('#editor').value);
      });

      $('#btn-bold').addEventListener('click',  () => wrapSelection($('#editor'), '*'));
      $('#btn-italic').addEventListener('click', () => wrapSelection($('#editor'), '_'));
      $('#btn-strike').addEventListener('click', () => wrapSelection($('#editor'), '~'));
      $('#btn-mono').addEventListener('click',   () => wrapSelection($('#editor'), '```', '```'));

      $('#btn-bullets').addEventListener('click', () => prefixLines($('#editor'), '• '));
      $('#btn-numbers').addEventListener('click', () => {
        const ta = $('#editor');
        const start = ta.selectionStart;
        const end = ta.selectionEnd;
        const val = ta.value;
        const before = val.slice(0, start);
        const sel = val.slice(start, end) || '';
        const after = val.slice(end);
        const lines = (sel || '\n').split('\n');
        let n = 1;
        const transformed = lines.map(l => l.trim() ? `${n++}. ${l}` : l).join('\n');
        ta.value = before + transformed + after;
        const newEnd = before.length + transformed.length;
        ta.focus(); ta.setSelectionRange(newEnd, newEnd);
        updatePreview();
      });

      $('#btn-clear').addEventListener('click', () => { $('#editor').value=''; updatePreview(); clearNote(); });
      $('#btn-copy').addEventListener('click', async () => {
        try { await navigator.clipboard.writeText($('#editor').value); setNote('Teks disalin ke clipboard.', 'info'); }
        catch { setNote('Gagal menyalin. Salin manual saja.', 'warn'); }
      });

      $('#btn-ai').addEventListener('click', aiFormat);
    });
  </script>
</body>
</html>
