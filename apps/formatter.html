<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AI Text Formatter ¬∑ MediaDash</title>
<style>
  :root{
    --bg:#0b0c0f; --card:#111318; --muted:#99a0ae; --accent:#6d5ef6;
    --green:#22c55e; --amber:#f59e0b; --red:#ef4444; --ring:#2a2f3a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#0b0c0f;color:#e7ebf3;font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;}
  a{color:#9aa4ff;text-decoration:none}
  .wrap{max-width:1200px;margin:auto;padding:24px}
  .topbar{display:flex;gap:12px;align-items:center;margin-bottom:20px}
  .btn-link{color:#cbd5e1}
  .title{font-size:28px;font-weight:700}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:24px}
  @media(max-width:1020px){.grid{grid-template-columns:1fr}}
  .section{background:var(--card);border:1px solid #1c2029;border-radius:16px;padding:16px}
  .section h3{margin:0 0 12px;font-size:18px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:720px){.row{grid-template-columns:1fr}}
  textarea{
    width:100%;min-height:160px;background:#0f1116;border:1px solid #1f2530;color:#e8ecf6;
    border-radius:12px;padding:12px;outline:none;resize:vertical;line-height:1.6;
  }
  textarea:focus{border-color:#2e3750;box-shadow:0 0 0 3px rgba(109,94,246,.15)}
  .toolbar{display:flex;gap:12px;align-items:center;margin-top:10px}
  .pill{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;border:1px solid #273043;background:#121420;color:#e6ebf6;font-weight:600;cursor:pointer}
  .pill.green{background:#0e1a14;border-color:#1f3b2a;color:#b7f3c6}
  .pill.amber{background:#171308;border-color:#3b2f12;color:#ffe1a6}
  .pill:disabled{opacity:.5;cursor:not-allowed}
  .err{margin-left:8px;color:#ffb4b4;font-size:12px}
  .editor{min-height:260px}
  .row-actions{display:flex;gap:10px;align-items:center;margin-top:8px}
  .ghost{border:1px dashed #2b3340;background:#0f1219;color:#b7c0d1}
  .ghost:hover{border-color:#3a4352}

  /* WhatsApp preview card */
  .wa-card{background:#e7ddd2;border-radius:24px;border:1px solid #cbbbae;overflow:hidden}
  .wa-head{background:#075E54;color:#fff;padding:10px 14px;display:flex;align-items:center;gap:10px}
  .wa-badge{background:#1a8f79;width:32px;height:32px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:700}
  .wa-name{font-weight:700}
  .wa-online{margin-left:auto;font-size:12px;opacity:.9}
  .wa-body{background:#efeae2;padding:16px;height:520px;overflow:auto;position:relative}
  .wa-bubble{
    max-width:78%;background:#dcf8c6;color:#0b141a;margin:8px 0 8px auto;border-radius:16px 16px 4px 16px;
    padding:10px 12px;box-shadow:0 1px 0 rgba(0,0,0,.08)
  }
  .wa-meta{display:flex;gap:6px;align-items:center;justify-content:flex-end;font-size:12px;color:#667781;margin-top:6px}
  .wa-meta .tick{width:14px;height:14px;border-radius:2px;background:
      linear-gradient(90deg,#34b7f1 0 50%,#34b7f1 50% 100%);}
  .note{color:var(--muted);font-size:12px;margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn-link" href="/">‚Üê Kembali</a>
      <div class="title">AI Text Formatter</div>
      <span class="note">Semua proses dilakukan lewat function <code>/call-gemini</code>.</span>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div style="display:flex;flex-direction:column;gap:16px">

        <div class="section">
          <h3>1. Format Berdasarkan Contoh</h3>
          <div class="row">
            <div>
              <div class="note" style="margin-bottom:6px">Tempel Teks Contoh (dengan format)</div>
              <textarea id="example" placeholder="Contoh teks yang formatnya ingin ditiru..."></textarea>
            </div>
            <div>
              <div class="note" style="margin-bottom:6px">Tempel Teks Baru (tanpa format)</div>
              <textarea id="newtext" placeholder="Konten baru yang ingin diformat mengikuti contoh..."></textarea>
            </div>
          </div>
          <div class="toolbar">
            <button id="btnMimic" class="pill">üìê Tiru Format</button>
            <small id="errMimic" class="err"></small>
          </div>
        </div>

        <div class="section">
          <h3>2. Format Cerdas & Ringkas</h3>
          <div class="toolbar">
            <button id="btnFormat" class="pill green">üß† Format Cerdas</button>
            <button id="btnSumm" class="pill amber">‚úÇÔ∏è Ringkas Teks</button>
            <small id="errSmart" class="err"></small>
          </div>

          <h3 style="margin-top:16px">Editor Utama & Hasil</h3>
          <textarea id="editor" class="editor" placeholder="Tulis atau tempel teks di sini..."></textarea>
          <div class="row-actions">
            <button id="btnCopy" class="pill ghost">Salin Hasil</button>
            <button id="btnClear" class="pill ghost">Bersihkan Semua</button>
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="section">
        <h3>Pratinjau WhatsApp <span class="note">simulasi</span></h3>
        <div class="wa-card">
          <div class="wa-head">
            <div class="wa-badge">MI</div>
            <div class="wa-name">MediaDash</div>
            <div class="wa-online">online</div>
          </div>
          <div class="wa-body">
            <div id="waBubble" class="wa-bubble">
              <div id="waText">Tampilan teks Anda akan muncul di sini‚Ä¶</div>
              <div class="wa-meta"><span id="waTime"></span><span class="tick"></span></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(function(){
  const $ = (q)=>document.querySelector(q);
  const ex = $('#example'), nw = $('#newtext'), ed = $('#editor');
  const errMimic = $('#errMimic'), errSmart = $('#errSmart');
  const waText = $('#waText'), waTime = $('#waTime');

  const FN = `${location.origin}/.netlify/functions/call-gemini`;

  function timeNow(){
    const d = new Date();
    let hh = d.getHours(), mm = d.getMinutes();
    const ampm = hh >= 12 ? 'PM':'AM';
    hh = ((hh+11)%12+1);
    mm = (mm<10? '0'+mm:mm);
    return `${hh}:${mm} ${ampm}`;
  }
  waTime.textContent = timeNow();
  setInterval(()=>waTime.textContent=timeNow(), 30_000);

  function setLoading(btn, loading){
    if(loading){
      btn.dataset.prev = btn.textContent;
      btn.textContent = '‚Ä¶ memproses';
      btn.disabled = true;
    }else{
      btn.textContent = btn.dataset.prev || btn.textContent;
      btn.disabled = false;
    }
  }

  async function callAI(action, payload){
    const res = await fetch(FN, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action, ...payload })
    });
    const j = await res.json().catch(()=>({ok:false,error:'INVALID_JSON'}));
    return {status:res.status, ...j};
  }

  function updatePreview(text){
    waText.textContent = text && text.trim() ? text : 'Tampilan teks Anda akan muncul di sini‚Ä¶';
  }

  ed.addEventListener('input', ()=>updatePreview(ed.value));

  // Actions
  $('#btnMimic').addEventListener('click', async ()=>{
    errMimic.textContent='';
    const exampleText = ex.value.trim();
    const newText = nw.value.trim();
    if(!exampleText || !newText){
      errMimic.textContent='PROMPT_REQUIRED: isi contoh & teks baru.';
      return;
    }
    setLoading(this,event.currentTarget);
  });

  // Fix: assign correct handler with setLoading
  const btnMimic = $('#btnMimic');
  btnMimic.addEventListener('click', async (ev)=>{
    errMimic.textContent='';
    const exampleText = ex.value.trim();
    const newText = nw.value.trim();
    if(!exampleText || !newText){
      errMimic.textContent='PROMPT_REQUIRED: isi contoh & teks baru.';
      return;
    }
    setLoading(btnMimic,true);
    const r = await callAI('mimic',{exampleText,newText});
    setLoading(btnMimic,false);
    if(!r.ok){ errMimic.textContent = r.error || `HTTP_${r.status}`; return; }
    ed.value = (r.text||'').trim(); updatePreview(ed.value);
  });

  const btnFormat = $('#btnFormat');
  btnFormat.addEventListener('click', async ()=>{
    errSmart.textContent='';
    const editorText = ed.value.trim();
    if(!editorText){ errSmart.textContent='PROMPT_REQUIRED: isi editor dahulu.'; return; }
    setLoading(btnFormat,true);
    const r = await callAI('format',{editorText});
    setLoading(btnFormat,false);
    if(!r.ok){ errSmart.textContent = r.error || `HTTP_${r.status}`; return; }
    ed.value = (r.text||'').trim(); updatePreview(ed.value);
  });

  const btnSumm = $('#btnSumm');
  btnSumm.addEventListener('click', async ()=>{
    errSmart.textContent='';
    const editorText = ed.value.trim();
    if(!editorText){ errSmart.textContent='PROMPT_REQUIRED: isi editor dahulu.'; return; }
    setLoading(btnSumm,true);
    const r = await callAI('summarize',{editorText});
    setLoading(btnSumm,false);
    if(!r.ok){ errSmart.textContent = r.error || `HTTP_${r.status}`; return; }
    ed.value = (r.text||'').trim(); updatePreview(ed.value);
  });

  $('#btnCopy').addEventListener('click', async ()=>{
    const txt = ed.value.trim();
    if(!txt) return;
    await navigator.clipboard.writeText(txt);
    const b = $('#btnCopy'); const prev=b.textContent; b.textContent='Disalin ‚úì';
    setTimeout(()=>b.textContent=prev,900);
  });
  $('#btnClear').addEventListener('click', ()=>{
    ex.value=''; nw.value=''; ed.value=''; updatePreview('');
  });

})();
</script>
</body>
</html>
